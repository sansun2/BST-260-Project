---
title: "BST 260_Happy Highs"
sub_title: "Exploring the Realm of Happiness and Well-being"
author: "Seranne Motital, Shravanthi Seshasayee, Sanjana Sunderesan"
date: "9 December 2017"
output: html_document
---

```{r echo=FALSE}
library(dplyr)
library(tidyverse)
library(knitr)
library(readr)
library(tidyverse)
library(readr)
library(ggplot2)
```

# Overview and Motivation

[The World Happiness Report](http://worldhappiness.report/overview/) is a composite measure of country-level happiness based on economic and social factors such as per capita GDP, social support, healthy life expectancy at birth, freedom to make life choices, generosity and perceptions of corruption, released annually by the United Nations Sustainble Development Solutions Network. In the present landscape of shifting political and economic climates across the world, we believe it is important to expand and include measures which encompass a wider narrative of the human experience. 

We are keen to understand the association between country-level physical, financial, social, cultural, political, and environmental indicators and the parent country's ranking on an overall well-being index. For instance, [literature](https://bmcpublichealth.biomedcentral.com/articles/10.1186/1471-2458-13-496) shows that "fear of crime represents a complex set of responses to the environment. It may play a role in mediating environmental impacts on health and wellbeing". Conversely, in his [book](http://www.palgrave.com/us/book/9780333548080), "Politics, Women and Well-being", Robin Jeffrey discusses the key role played by a more gender-equal society in the overall health and improvement of a state in India. 

Similar to these findings, we strongly believe it is of great relevance to learn more about the influences of variables such as Gini Coefficients, literacy levels, deforestation, climate etc. on the happiness and well-being of a country as a whole.

We hope to understand the underlying variables most responsible for these scores, and identify conceptual and measurement gaps in the development of an overall score of country-level well-being. We believe that factors such as racial diversity, environmental sustainability, and population skew, among others, are either missing or underrepresented in the present composite measure. We aim to modify this to build a more well-rounded measure of the well-being of a country.  
We believe that this information could potentially inform policies to improve overall country happiness and human flourishing.  

# Initial Questions: 

We began our project with the goal of identifying yearly-changes in a country's happiness and well-being. However, as we learnt more about how these composite indices are derived, we grew keen to understand the factors considered in the creation of a well-being score. Over the course of our literature review, we identified more variables we believe are relevant to a population's well-being, and decided to create a new, incremented ranking of country well-being with this additional data. Thus, our project seeks to answer: 

Is there a change in the average ranking of a country's happiness and well-being, given the inclusion of a more comprehensive variable list representing its physical, social, cultural, economic and political enviroments?

# Methods:

In order to develop our well-being index, we extracted data from a number of resources, categorized below: 

```{r}
org = c("World Bank", "United Nations Sustainable Development Solutions Network", "New Economics Foundation", "Wikipedia (Fearon's Analysis)")
dat <- c("World Development Indicators (2010-17)", "World Happiness Report", "Happy Planet Index", "Ethnic Fractionalization Index")

datasources <- data.frame("Source" = org, "Data" = dat)
categs <- c("Child Welfare", "Gender", "Employment","Economic Indicators", "Energy Indicators", "Emissions", "Connectivity", "Environmental Welfare", "Food Deficit", "Sense of Security", "Travel for Leisure")

categs <- data.frame("Population Characteristics" = categs)

print(kable(datasources))
print(kable(categs))

#dsources <- c("World Bank: World Development Indicators", "Happy Planet Index", "Wikipedia", "UN SDSN: World Happiness Report")
#dframe1 %>% data.frame("Indicators" = categs) %>% kable
```

From each of our sources, we selected variables most relevant to the creation of our composite index (based on literature review). After a review of the [Handbook on Constructing Composite Score Indicators](https://www.oecd.org/std/42495745.pdf) released by the OECD examining weighting techniques in social and demographix index development, we decided to provide equal weightage to all variables, to provide countries with lesser-utilized variables equal opportunity to receive higher ranks in the final index.

A country-wise ranking was then generated for each variable, in every category. Every country then received a category-wise composite score, calculated as an equally-weighted average of the mean variable ranks. 

<<<<<<< HEAD
# Exploratory Analysis: What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?
=======
# Exploratory Analysis: 

>>>>>>> 9fd07cc0fa2e3dc42286b64a039fd181049eb68a

- Samples in the WHR (1000 per country not taking into acount population density or total population), doesn't take into consideration - 
- Scatterplot of the WHR countries ranks?
- Association between maybe ethnic fractionalization/total population/environmental biodiversity and these ranks? [T perhaps justify why we don't think that these ranks are very accurate]

```{r}

```

## Methods: 

# Extracting data from the World Bank World Development Indicators

The World Bank's World Development Indicators were downloaded from [Kaggle](https://www.kaggle.com/worldbank/world-development-indicators), and this dataset is available for download as a .csv from [this link](https://drive.google.com/open?id=1ilfW3OIrVs6b4EsFPFbW-dw_vQiQgetU). However, given the large size of this data, our initial stage dataset is available as a smaller-sized url-linked csv (in the following code chunk), on which the rest of the code was run.

```{r, eval=FALSE}
# Replace path name with that of the downloaded csv file
Indicators_csv <- read_csv("Download/Path/Here.csv")

# Filter by Year
WDI <- filter(Indicators_csv, Year == "2010"| Year == "2011" | Year == "2012"| Year == "2013" | Year == "2014" | Year == "2015" | Year == "2016" | Year =="2017")

# Remove Aggregated Country classifications, by country code
WDInew <- filter(WDI, CountryCode != "WBG")
WDInew <- filter(WDInew, CountryCode != "WLD")
WDInew <- filter(WDInew, CountryCode != "UMC")
WDInew <- filter(WDInew, CountryCode != "SST")
WDInew <- filter(WDInew, CountryCode != "SSF")
WDInew <- filter(WDInew, CountryCode != "SSA")
WDInew <- filter(WDInew, CountryCode != "SAS")
WDInew <- filter(WDInew, CountryCode != "OSS")
WDInew <- filter(WDInew, CountryCode != "OED")
WDInew <- filter(WDInew, CountryCode != "MNA")
WDInew <- filter(WDInew, CountryCode != "MEA")
WDInew <- filter(WDInew, CountryCode != "LMC")
WDInew <- filter(WDInew, CountryCode != "LIC")
WDInew <- filter(WDInew, CountryCode != "LMY")
WDInew <- filter(WDInew, CountryCode != "LDC")
WDInew <- filter(WDInew, CountryCode != "LAC")
WDInew <- filter(WDInew, CountryCode != "LCN")
WDInew <- filter(WDInew, CountryCode != "OEC")
WDInew <- filter(WDInew, CountryCode != "NOC")
WDInew <- filter(WDInew, CountryCode != "NAC")
WDInew <- filter(WDInew, CountryCode != "MIC")
WDInew <- filter(WDInew, CountryCode != "HIC")
WDInew <- filter(WDInew, CountryCode != "HPC")
WDInew <- filter(WDInew, CountryCode != "FCS")
WDInew <- filter(WDInew, CountryCode != "EUU")
WDInew <- filter(WDInew, CountryCode != "ECA")
WDInew <- filter(WDInew, CountryCode != "ECS")
WDInew <- filter(WDInew, CountryCode != "EMU")
WDInew <- filter(WDInew, CountryCode != "EAP")
WDInew <- filter(WDInew, CountryCode != "EAS")
WDInew <- filter(WDInew, CountryCode != "CEB")
WDInew <- filter(WDInew, CountryCode != "ARB")

# Filter dataset to only include variables of interest 
WDI2 <- filter(WDInew, IndicatorCode == "AG.LND.FRST.ZS" | IndicatorCode == "EG.FEC.RNEW.ZS"|IndicatorCode == "EG.USE.COMM.FO.ZS"|IndicatorCode == "EG.ELC.ACCS.ZS"|IndicatorCode == "EG.USE.ELEC.KH.PC"| IndicatorCode == "EN.ATM.CO2E.PC"|IndicatorCode == "ER.PTD.TOTL.ZS"| IndicatorCode == "EN.POP.DNST"|IndicatorCode == "ER.PTD.TOTL.ZS"|IndicatorCode == "FP.CPI.TOTL.ZG"|IndicatorCode == "GC.XPN.COMP.ZS"|IndicatorCode == "IC.FRM.CRIM.ZS"|IndicatorCode == "IC.FRM.FEMM.ZS"|IndicatorCode == "IC.LGL.CRED.XQ"|IndicatorCode == "IT.CEL.SETS.P2"|IndicatorCode == "IT.NET.USER.P2"|IndicatorCode == "MS.MIL.XPND.GD.ZS"|IndicatorCode == "NY.GDP.PCAP.CD"|IndicatorCode == "NY.GDP.MKTP.PP.CD"|IndicatorCode == "NY.GDP.PCAP.KD.ZG"|IndicatorCode == "SE.ADT.1524.LT.ZS"|IndicatorCode == "SE.ADT.LITR.ZS"|IndicatorCode == "SG.GEN.PARL.ZS"|IndicatorCode == "SG.VAW.REAS.ZS"|IndicatorCode == "SH.DTH.MORT"|IndicatorCode == "SI.POV.GINI"|IndicatorCode == "SL.EMP.WORK.ZS"|IndicatorCode == "SL.FAM.0714.ZS"|IndicatorCode == "SP.DYN.IMRT.IN"|IndicatorCode == "SL.UEM.NEET.ZS"|IndicatorCode == "SM.POP.TOTL.ZS"|IndicatorCode == "SN.ITK.DFCT"|IndicatorCode == "SP.DYN.LE00.IN"|IndicatorCode == "SP.UWT.TFRT"|IndicatorCode == "ST.INT.DPRT"|IndicatorCode == "SP.POP.TOTL"|IndicatorCode == "VC.IHR.PSRC.P5")

write.csv(WDI2, file = "ourWDI.csv")
```

If the above original dataset was not downloaded, the code below runs on the .csv generated at the end of the above code chunk 

```{r}
# Load dataset
url <- "https://raw.githubusercontent.com/Seranne/IntroDSproject/master/ourWDI.csv"
WDI4 <- read.csv(url)
WDI4<- select(WDI4,"CountryName","CountryCode", "IndicatorCode", "Year","Value")

# Change Country Names to standard names
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Micronesia, Fed. Sts."] <- "Micronesia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "United States"] <- "United States of America"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Congo, Rep."] <- "Republic of Congo"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Russian Federation"] <- "Russia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Congo, Dem. Rep."] <- "Democratic Republic of Congo"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Eygpt, Arab Rep."] <- "Egypt"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Iran, Islamic Rep."] <- "Iran"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Korea, Dem. Rep"] <- "North Korea"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Korea, Rep."] <- "South Korea"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Kyrgyz Republic"] <- "Kyrgyzstan"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Slovak Republic"] <- "Slovakia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Syrian Arab Republic"] <- "Syria"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "China & Hong Kong SAR, China"] <- "Hong Kong"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Macedonia, FYR"] <- "Macedonia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Bahamas, The"] <- "Bahamas"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Gambia, The"] <- "Gambia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Venezuela, RB"] <- "Venezuela"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Yemen, Rep."] <- "Yemen"
```


# Generating Category scores for each country

Composite Energy Score: 

```{r}
# Selecting indicators of interest 
Energy <- WDI4%>% filter(IndicatorCode == "EG.FEC.RNEW.ZS"|IndicatorCode == "EG.USE.COMM.FO.ZS"|IndicatorCode == "EG.ELC.ACCS.ZS"|IndicatorCode == "EG.USE.ELEC.KH.PC") %>% spread(IndicatorCode, Value)

<<<<<<< HEAD

#reoving rows with too many na's and filling in remaining na's with same country means
 Energy <- Energy[order(-Energy$Year),]
=======
Energy <- Energy[order(-Energy$Year),]
>>>>>>> 3081b7b0338774f1563d5cbfc16517056e7601fb
 Energy[rowSums(is.na(Energy)) < ncol(Energy)/2, ]
 Energy<- aggregate(x=Energy[c("EG.ELC.ACCS.ZS","EG.FEC.RNEW.ZS","EG.USE.COMM.FO.ZS","EG.USE.ELEC.KH.PC")], by=list(name=Energy$CountryName), FUN = "mean" , na.rm = TRUE)
 colnames(Energy)[1] <- "CountryName"
  Energy[rowSums(is.na(Energy1)) < ncol(Energy)/2, ]
 Energy <- Energy%>% distinct(CountryName, .keep_all = TRUE)

 # Access to Electricity (% of population); Highest score gets ranked 1
 Energy1<- select(Energy, "CountryName",  "EG.ELC.ACCS.ZS")
<<<<<<< HEAD
 Energy1 <- Energy1 %>% mutate(finalrank_eng1 = rank(-Energy1$EG.ELC.ACCS.ZS))
 Energy1$finalrank_eng1<- as.numeric(as.factor(Energy1$finalrank_eng1))
 
  # Renewable Energy Consumption (% of final energy consumption); Highest percentage gets ranked 1
 
 Energy2<- select(Energy, "CountryName",  "EG.FEC.RNEW.ZS")
 Energy2 <- Energy2 %>% mutate(finalrank_eng2 = rank(-Energy2$EG.FEC.RNEW.ZS))
 Energy2$finalrank_eng2<- as.numeric(as.factor(Energy2$finalrank_eng2))
 
  # Fossil fuel energy consumption (% of total);lowest consumption ranked 1
 
 Energy3<- select(Energy, "CountryName",  "EG.USE.COMM.FO.ZS")
 Energy3 <- Energy3 %>% mutate(finalrank_eng3 = rank(Energy3$EG.USE.COMM.FO.ZS))
 Energy3$finalrank_eng3<- as.numeric(as.factor(Energy3$finalrank_eng3))
 
 
 Enjoin <- left_join(Energy1, Energy2, "CountryName")
 Energy<- left_join(Enjoin, Energy3, "CountryName")
 Energy<- select(Energy,"CountryName", "finalrank_eng1", "finalrank_eng2", "finalrank_eng3")
 
 
# Highest aggregate score is ranked 1
Energy_score <- Energy %>% mutate(score_eng = (finalrank_eng1 + finalrank_eng2 + finalrank_eng3 )/3)
Energy_score <- Energy_score %>% mutate(finalrank_eng = rank(Energy_score$score_eng))

```

CO2 Emissions score:

```{r}
# Select indicator variable: CO2 emissions (metric tons per capita)
emissions <- WDI4%>% filter(IndicatorCode == "EN.ATM.CO2E.PC")%>% spread(IndicatorCode, Value)

# Lowest score gets ranked 1
emissions_score <- emissions %>% 
  group_by(CountryName) %>% 
  summarise(mean_CO2 = mean(EN.ATM.CO2E.PC)) %>%
  na.omit() %>%
  mutate(finalrank_emission = rank(mean_CO2))
```

Composite Environmental well-being score: 

```{r}
# Selecting indicator variables: Terrestrial and marine protected areas (% of total territorial area) and Forest area (% of land area)

envir <- WDI4 %>% filter(IndicatorCode == "ER.PTD.TOTL.ZS"|IndicatorCode == "AG.LND.FRST.ZS") %>% spread(IndicatorCode, Value)

# Highest score gets ranked 1
environment_score <- envir %>% 
  group_by(CountryName) %>% 
  na.omit() %>%
  summarise(mean_agland = mean(AG.LND.FRST.ZS), mean_protect = mean(ER.PTD.TOTL.ZS)) %>%
  mutate(rank_agland = rank(mean_agland), rank_protect = rank(mean_protect)) %>%
  mutate(score = (rank_agland+rank_protect)/2) %>%
  mutate(finalrank_env = rank(-score)) %>%
  select(CountryName, finalrank_env)
```

Communication/Connectivity score: 

```{r}
# Score based on Mobile cellular subscriptions (per 100 people) and Internet Users (per 100 people)
# Highest score gets ranked 1 

Communication <- WDI4 %>% filter(IndicatorCode == "IT.CEL.SETS.P2"|IndicatorCode == "IT.NET.USER.P2")  %>% spread(IndicatorCode, Value)
 Communication <- Communication[order(-Communication$Year),]
 Communication[rowSums(is.na(Communication)) < ncol(Communication)/2, ]
 Communication<- aggregate(x=Communication[c("IT.CEL.SETS.P2","IT.NET.USER.P2")], by=list(name=Communication$CountryName), FUN = "mean" , na.rm = TRUE)
 colnames(Communication)[1] <- "CountryName"
Communication <- Communication %>% mutate(rankcell = rank(IT.CEL.SETS.P2)) 
Communication <- Communication %>% mutate(ranknet = rank(IT.NET.USER.P2))
Communication <- Communication %>% mutate(score = (rankcell+ranknet)/2)
Communication <- Communication %>% mutate(finalrank_comm = rank(-Communication$score))
Communication_score <- select(Communication, "CountryName", "finalrank_comm" )
```

Composite Child Welfare score:

```{r}
children<- WDI4 %>% filter(IndicatorCode == "SL.FAM.0714.ZS"|IndicatorCode == "SL.UEM.NEET.ZS" | IndicatorCode == "SP.DYN.IMRT.IN") %>% spread(IndicatorCode, Value)

# Share of children not in education, employment or training: lowest score gets ranked 1 
neet <- select(children, "CountryName", "Year", "SL.UEM.NEET.ZS")
neet <- neet[order(-neet$Year),]
neet <- na.omit(neet)
neet <- neet %>% distinct(CountryName, .keep_all = TRUE)

# Infant mortality rate: lowest score gets ranked 1
imr <- select(children, "CountryName", "Year", "SP.DYN.IMRT.IN")
imr <- imr[order(-imr$Year),]
imr <- na.omit(imr)
imr <- imr %>% distinct(CountryName, .keep_all = TRUE)
imr <- mutate(imr, rank.imr = as.numeric(as.factor(rank((SP.DYN.IMRT.IN)))))

# Lowest aggregrate score gets ranked 1, indicating best child welfare score 

childwelfare <- left_join(imr, neet, by = "CountryName")
childwelfare <- select(childwelfare, "CountryName", "SL.UEM.NEET.ZS", "SP.DYN.IMRT.IN", "rank.imr")

# Filling missing values in NEET using average of othercountry NEET scores 
avgneet <- mean(neet$SL.UEM.NEET.ZS)
childwelfare$SL.UEM.NEET.ZS[is.na(childwelfare$SL.UEM.NEET.ZS)] <- avgneet
childwelfare <- mutate(childwelfare, rank.neet = as.numeric(as.factor(rank((SL.UEM.NEET.ZS)))))
childwelfare_score <- mutate(childwelfare, finalscore_child = as.numeric
                       (as.factor(rank(((rank.neet+rank.imr)/2)))))
```

Food Deficit score:

```{r}
# Load dataset and select indicator: Depth of the food deficit (kilocalories per person per day)
deficit <- WDI4 %>% filter(IndicatorCode == "SN.ITK.DFCT") %>% spread(IndicatorCode, Value)

# Country with the least food deficit will rank 1
deficit <- select(deficit, "CountryName", "Year", "SN.ITK.DFCT")
deficit <- deficit[order(-deficit$Year),]
deficit <- deficit %>% distinct(CountryName, .keep_all = TRUE)
View(deficit)

deficit.score = as.numeric(as.factor(rank((deficit$SN.ITK.DFCT))))
deficit_score <- deficit %>% mutate(finalrank_deficit = 
                                as.numeric(as.factor(rank((deficit$SN.ITK.DFCT)))))
```

Economic score: 

```{r}
# Selecting relevant economic indicators
GDP_base <- WDI4 %>% filter(IndicatorCode == "MS.MIL.XPND.GD.ZS"|IndicatorCode == "NY.GDP.PCAP.CD"|IndicatorCode == "NY.GDP.MKTP.PP.CD"|IndicatorCode == "NY.GDP.PCAP.KD.ZG"|IndicatorCode == "FP.CPI.TOTL.ZG") %>% spread(IndicatorCode, Value)

#Individual data frames for each variable of GDP

#Military expenditure (% of GDP) - Lowest expenditure will be ranked 1
gdp_1 <- GDP_base %>% 
  select(CountryName, Year, MS.MIL.XPND.GD.ZS) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_mil = mean(MS.MIL.XPND.GD.ZS)) %>%
  mutate(finalrank_mil = rank(mean_mil))

#GDP per capita (in USD) - Country with the highest GDP will be ranked 1
gdp_2 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.MKTP.PP.CD) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_ppp = mean(NY.GDP.MKTP.PP.CD)) %>%
  mutate(finalrank_ppp = rank(-mean_ppp))

#GDP per capita, PPP (in current international dollar) - Country with the highest GDP will be ranked 1
gdp_3 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.PCAP.CD) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_gdp = mean(NY.GDP.PCAP.CD)) %>%
  mutate(finalrank_gdp = rank(-mean_gdp))

#GDP per capita growth (annual %) - Country with highest GDP will be ranked 1
gdp_4 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.PCAP.KD.ZG) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_gdpg = mean(NY.GDP.PCAP.KD.ZG)) %>%
  mutate(finalrank_gdpg = rank(-mean_gdpg))

#Inflation (annula %) - Country with the lowest annual inflation % will rank 1
gdp_5 <- GDP_base %>% 
  select(CountryName, Year, FP.CPI.TOTL.ZG) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_infl = mean(FP.CPI.TOTL.ZG)) %>%
  mutate(finalrank_infl = rank(mean_infl))

#Joining the ranks from all of the variables
GDP_a <- left_join(gdp_1, gdp_2, "CountryName")
GDPjoin <- left_join(GDP_a, gdp_3, "CountryName")
GDPjoin <- left_join(GDPjoin, gdp_4, "CountryName")
GDPjoin <- left_join (GDPjoin, gdp_5, "CountryName")
GDP2 <- GDPjoin %>% select(CountryName, finalrank_mil, finalrank_ppp, finalrank_gdp, finalrank_gdpg, finalrank_infl)

GDP2 <- GDP2[rowSums(is.na(GDP2)) < 4, ]
i <- which(is.na(GDP2), arr.ind = TRUE)
GDP2[i] <- rowMeans(GDP2[,-1], na.rm = TRUE)[i[,1]]

# Country with the highest average score will rank 1
GDP2 <- GDP2 %>% mutate(score_gdp = (finalrank_mil + finalrank_ppp+ finalrank_gdp + finalrank_gdpg + finalrank_infl)/5)
economy_score <- GDP2 %>% mutate(finalrank_GDP = rank(GDP2$score_gdp))
```

Education score:

```{r}
# Selecting relevant indicator variables: Youth literacy rate, population 15-24 years, both sexes (%) and Adult literacy rate, population 15+ years, both sexes (%) 

Education <- WDI4 %>% filter(IndicatorCode == "SE.ADT.1524.LT.ZS"|IndicatorCode == "SE.ADT.LITR.ZS") %>% spread(IndicatorCode, Value)

# Highest rate of youth literacy will be ranked 1
En1<- select(Education, "CountryName", "CountryCode", "Year", "SE.ADT.1524.LT.ZS")
En1 <- En1[order(-En1$Year),]
En1<- na.omit(En1)
En1 <- En1%>% distinct(CountryName, .keep_all = TRUE)
En1 <- En1 %>% mutate(rank_eng1 = rank(-En1$SE.ADT.1524.LT.ZS))
En1$rank_eng1<- as.numeric(as.factor(En1$rank_eng1))

# Highest rate of adult literacy will be ranked 1
En2<- select(Education, "CountryName", "CountryCode", "Year", "SE.ADT.LITR.ZS")
En2 <- En2[order(-En2$Year),]
En2<- na.omit(En2)
En2 <- En2%>% distinct(CountryName, .keep_all = TRUE)
En2 <- En2 %>% mutate(rank_eng2 = rank(-En2$SE.ADT.LITR.ZS))
En2$rank_eng2<- as.numeric(as.factor(En2$rank_eng2))

# Country with the highest average literacy rte will be ranked 1
litjoin <- left_join(En1, En2, "CountryName")
Education <- select(litjoin,"CountryName", "rank_eng1", "rank_eng2")
Education <- Education%>% mutate(score_edu = (rank_eng1 + rank_eng2)/2)
Education_score <- Education %>% mutate(finalrank_edu = rank(Education$score_edu))
```

Gender score:

```{r}
# Select indicator variable to assess gender equity: Proportion of seats held by women in national partliaments (%)

gender <- WDI4 %>% filter(IndicatorCode == "SG.GEN.PARL.ZS") %>% spread(IndicatorCode, Value)

gender <- select(gender, "CountryName", "CountryCode", "Year", "SG.GEN.PARL.ZS")
gender <- gender[order(-gender$Year),]
gender <- na.omit(gender)
gender <- gender%>% distinct(CountryName, .keep_all = TRUE)
Gender_score <- gender %>% mutate(finalrank_gen = rank(-gender$SG.GEN.PARL.ZS))
Gender_score$finalrank_gen<- as.numeric(as.factor(Gender_score$finalrank_gen))
```

Employment score:

```{r}
# Select indicator variable: Wage and salaried workers, total (% of total employed)
# country with the highest % of wage and salaried workers will be ranked 1

empl<- WDI4 %>% filter(IndicatorCode == "SL.EMP.WORK.ZS") %>% spread(IndicatorCode, Value)
empl <- select(empl, "CountryName", "Year", "SL.EMP.WORK.ZS")
empl <- empl[order(-empl$Year),]
empl <- empl %>% distinct(CountryName, .keep_all = TRUE)

employment_score <- empl %>% mutate(finalrank_empl =
                          as.numeric(as.factor(rank(-(empl$SL.EMP.WORK.ZS)))))
```

Population score:

```{r}
# Select relevant indicator variables

Population <- WDI4 %>% filter(IndicatorCode == "SI.POV.GINI"|IndicatorCode == "SM.POP.TOTL.ZS"|IndicatorCode == "SP.DYN.LE00.IN" | IndicatorCode == "SP.POP.TOTL"| IndicatorCode == "EN.POP.DNST") %>% spread(IndicatorCode, Value)

 Population <- Population[order(-Population$Year),]
 Population[rowSums(is.na(Population)) < ncol(Population)/2, ]
 Population<- aggregate(x=Population[c("EN.POP.DNST","SI.POV.GINI","SM.POP.TOTL.ZS","SP.DYN.LE00.IN", "SP.POP.TOTL")], by=list(name=Population$CountryName), FUN = "mean" , na.rm = TRUE)
 colnames(Population)[1] <- "CountryName"
  Population[rowSums(is.na(Population1)) < ncol(Population)/2, ]
 Population <- Population%>% distinct(CountryName, .keep_all = TRUE)

# Population density (people per sq. km of land area): Lowest ranked 1
 Population1<- select(Population, "CountryName", "EN.POP.DNST")
 Population1 <- Population1 %>% mutate(finalrank_pop1 = rank(Population1$EN.POP.DNST))
 Population1$finalrank_pop1<- as.numeric(as.factor(Population1$finalrank_pop1))
 
 # GINI index: Lowest ranked 1
 Population2<- select(Population, "CountryName", "SI.POV.GINI")
 Population2 <- Population2 %>% mutate(finalrank_pop2 = rank(Population2$SI.POV.GINI))
 Population2$finalrank_pop2<- as.numeric(as.factor(Population2$finalrank_pop2))
 
 
# Life expectancy at birth (total, in years): Highest ranked 1
 Population3<- select(Population, "CountryName", "SP.DYN.LE00.IN")
 Population3 <- Population3 %>% mutate(finalrank_pop3 = rank(-Population3$SP.DYN.LE00.IN))
 Population3$finalrank_pop3<- as.numeric(as.factor(Population3$finalrank_pop3))
 

 # Total score: Best aggregrate score ranked 1 
 Popjoin <- left_join(Population1, Population2, "CountryName")
Population <- left_join(Popjoin, Population3, "CountryName")

 Population<- select(Population,"CountryName", "finalrank_pop1", "finalrank_pop2", "finalrank_pop3")
 
 
 Population_score <- Population %>% mutate(score_pop = ((finalrank_pop1 + finalrank_pop2 + finalrank_pop3)/3))
 Population_score <- Population_score %>% mutate(finalrank_pop = rank(Population_score$score_pop))

```

Sense of Security Composite score:

```{r}

security <- WDI4 %>% filter(IndicatorCode == "VC.IHR.PSRC.P5"|IndicatorCode == "IC.LGL.CRED.XQ") %>% spread(IndicatorCode, Value)

#Strength of legal system - rank generates best legal strength at 1
legal <- select(security, "CountryName", "Year", "IC.LGL.CRED.XQ")
#crime[crime == 0] <- NA
legal <- legal[order(-legal$Year),]
legal <- na.omit(legal)
legal <- legal %>% distinct(CountryName, .keep_all = TRUE)
legal <- mutate(legal, rank.legal = as.numeric(as.factor(rank(-(IC.LGL.CRED.XQ)))))

#Intentional Homicide rate (per 100,000) - Rank generates least homicide rate at 1
homicide <- select(security, "CountryName", "Year", "VC.IHR.PSRC.P5")
homicide[homicide == 0] <- NA
homicide <- homicide[order(-homicide$Year),]
homicide<- na.omit(homicide)
homicide <- homicide%>% distinct(CountryName, .keep_all = TRUE)
homicide <- mutate(homicide, rank.homi = as.numeric(as.factor(rank(VC.IHR.PSRC.P5))))

#Lower country.scores have higher security 
security_score <- left_join(legal, homicide, by = "CountryName")

security_score <- select(security_score, "CountryName", "IC.LGL.CRED.XQ", "rank.legal", "VC.IHR.PSRC.P5", "rank.homi")

security_score <- mutate(security_score, finalscore_security = as.numeric(as.factor(rank(((rank.legal+rank.homi)/2)))))
```

Tourism score:

```{r}
# Selecting indicator: number of international departures (% of total population)
tourism <- WDI4 %>% filter(IndicatorCode == "ST.INT.DPRT") %>% spread(IndicatorCode, Value)
write.csv(Tourism, file = "Tourism.csv")

tourism <- select(tourism, "CountryName", "Year", "ST.INT.DPRT")
tourism <- tourism[order(-tourism$Year),]
tourism <- tourism %>% distinct(CountryName, .keep_all = TRUE)
View(tourism)

Population <- filter(Population, pop$Year == "2013")
Population <- select(Population, "CountryName", "SP.POP.TOTL")
tour <- left_join(tourism, Population, by = "CountryName")

# Highest score will get a rank of 1 
tourism_score <- tour %>% mutate(finalrank_tourism = rank(-(tour$ST.INT.DPRT/tour$SP.POP.TOTL)))
```

Ethnic Diversity: Ethniz Fractionalization is commonly used in Economics literature to compare the levels of ethnic, cultural, linguistic and religious fractionalization in different countries ([Wikipedia](https://en.wikipedia.org/wiki/List_of_countries_ranked_by_ethnic_and_cultural_diversity_level)). We use this as a measure of ethnic diversity in a country. Inclusion of this measure is one of the key strengths of our  project, since this was not included in earlier World Happiness Indices, but has been shown to be associated with health and [well-being](http://ftp.iza.org/dp9726.pdf). At a time when more [future research](http://www.nuffieldfoundation.org/impact-ethnic-diversity-well-being-and-health) is also being undertaken in this domain, we find it particularly relevant to include this in our index.

```{r}
url <- "https://en.wikipedia.org/wiki/List_of_countries_ranked_by_ethnic_and_cultural_diversity_level"
pop <- read_csv("../WDI data split/Population.csv")
h <- read_html(url)
efindex <- h %>% html_nodes("table") %>% html_table(fill = TRUE) %>%
        .[[3]]

diversity <- select(efindex, "Country", "Ethnic Diversity Rank")
colnames(diversity)[1] <- "CountryName"
colnames(diversity)[2] <- "finalrank_diversity"
```

# Extracting Data from the World Happiness Report Dataset

UN SDSN World Happiness Report Data is available for the years 2015, 2016 and 2017:

```{r}
# Load datasets
url1 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2015.csv"
url2 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2016.csv"
url3 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2017.csv"

gh2015 <- read.csv(url1)
gh2016 <- read.csv(url2)
gh2017 <- read.csv(url3)

# Selecting required indicators
GHI2015 <- select(gh2015, "Country", "Region", "Family", "Freedom", "Trust (Government Corruption)", "Generosity", "Dystopia Residual")
GH2016 <- select(gh2016, "Country", "Region", "Family", "Freedom", "Trust (Government Corruption)", "Generosity", "Dystopia Residual")
GH2017 <- select(gh2017, "Country", "Family", "Freedom", "Trust..Government.Corruption.", "Generosity", "Dystopia.Residual")

gh <- read_csv("Original Data/online-data-chapter-2-whr-2017.csv")

gh1 <- gh %>% select(country, year, `Social support`, Generosity, `Freedom to make life choices`, `Perceptions of corruption`, `Confidence in national government`, `Positive affect`, `Negative affect`) %>% filter(year == 2016)

whr <- read_csv("Original Data/gh2017.csv")

whr <- whr %>% select(Country, Dystopia.Residual) %>% mutate(country = Country)

WHR <- left_join(gh, whr, "country")  
colnames(WHR)[2] <- "CountryName"
write.csv(WHR, file = "final_whr.csv")

#Citizen report of positive feelings
pos_affect <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_pa = mean(`Positive affect`)) %>%
  na.omit() %>%
  mutate(finalrank_pos = rank(mean_pa))

write.csv(pos_affect, file = "Positive Affect.csv")

#Citizen report of negative feelings
neg_affect <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_na = mean(`Negative affect`)) %>%
  na.omit() %>%
  mutate(finalrank_neg = rank(mean_na))
View(neg_affect)
write.csv(neg_affect, file = "Negative Affect.csv")

#Dystopia score

dystopia <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_dys = mean(Dystopia.Residual)) %>%
  na.omit() %>%
  mutate(finalrank_dys = rank(mean_dys))
View(dystopia)
write.csv(dystopia, file = "Dystopia_score.csv")


```

# Extracting Data from the Happy Planet Index

2016 Happy Planet Index data is available through [this link](http://happyplanetindex.org/countries). A cleaned .CSV is available through the code below this one, on which further analysis was run.

```{r, EVAL=FALSE}
# Load dataset
hpi_data_2016 <- readxl::read_xlsx("Your/File/Path/Here.xlsx")
hpi_data_2016 <- read_csv("../IntroDSproject/Original Data/hpi-data-2016.csv")

<<<<<<< HEAD
#As other variables have been Covered in previous categories, only wellbeing index was selected for our score

colnames(hpi_data_2016)[2] <- "CountryName"
 hpi_data_20162<- select(hpi_data_2016, "CountryName", "Inequality-adjusted_Wellbeing")
 hpi_data_20162<- na.omit(hpi_data_20162)
 hpi_data_20162 <- hpi_data_20162%>% distinct(CountryName, .keep_all = TRUE)
 hpi_data_20162 <- hpi_data_20162 %>% mutate(finalrank_hpi2 = rank(-hpi_data_20162$`Inequality-adjusted_Wellbeing`))
 hpi_data_20162$finalrank_hpi2<- as.numeric(as.factor(hpi_data_20162$finalrank_hpi2))
 
hpi_data_2016<- select(hpi_data_20162,"CountryName",  "finalrank_hpi2")
 

 happyplanet_score <- hpi_data_2016 %>% mutate(score_hpi = finalrank_hpi2 )
 happyplanet_score <- happyplanet_score %>% mutate(finalrank_hpi = rank(happyplanet_score$score_hpi))
 

```

```{r}
# Load dataset
HPI2016 <- read.csv("https://raw.githubusercontent.com/Seranne/IntroDSproject/master/Cleaned_Data/cleaned_hpi_2016.csv")
```


# Checking for correlations between indicators chosen based on literature review

# Deriving new well-rounded well-being index 

#Gather all the variable indices join to create on table 

```{r}
Communication_score <- read_csv("../Scored data+Rmds/Communication_score.csv")
Education_score <- read_csv("../Scored data+Rmds/Education_score.csv")
Emissions_score <- read_csv("../Scored data+Rmds/Emissions_score.csv")
Employment_score <- read_csv("../Scored data+Rmds/Employment_score.csv")
Energy_score <- read_csv("../Scored data+Rmds/Energy_score.csv")
Environment_score <- read_csv("../Scored data+Rmds/Environment_score.csv")
FoodDeficit_score <- read_csv("../Scored data+Rmds/FoodDeficit_score.csv")
Gender_score <- read_csv("../Scored data+Rmds/Gender_score.csv")
Population_score <- read_csv("../Scored data+Rmds/Population_score.csv")
Security_score <- read_csv("../Scored data+Rmds/Security_score.csv")
Tourism_score <- read_csv("../Scored data+Rmds/Tourism_score.csv")
GDP_score <- read_csv("../Scored data+Rmds/GDP_score.csv")
childwelfare_score <- read_csv("../Scored data+Rmds/childwelfare_score.csv")
diversity_score <- read_csv("../Scored data+Rmds/diversity_score.csv")
happyplanet_score <- read_csv("../Scored data+Rmds/happyplanet_score.csv")
Negative_Affect <- read_csv("../Scored data+Rmds/Negative Affect.csv")
Positive_Affect <- read_csv("../Scored data+Rmds/Positive Affect.csv")
```


```{r}
final_score_table <- communication_score %>%
  full_join(education_score, by='CountryName') %>%
  full_join(emissions_score, by='CountryName') %>%
  full_join(environment_score, by='CountryName') %>%
  full_join(foodDeficit_score, by='CountryName') %>%
  full_join(gender_score, by='CountryName') %>%
  full_join(population_score, by='CountryName') %>%
  full_join(employment_score, by='CountryName') %>%
  full_join(energy_score, by='CountryName') %>%
  full_join(security_score, by='CountryName') %>%
  full_join(tourism_score, by='CountryName') %>%
  full_join(economy_score, by='CountryName') %>%
  full_join(childwelfare_score, by='CountryName')%>%
  full_join(diversity_score, by='CountryName')%>%
  full_join(happyplanet_score, by='CountryName')%>%
  full_join(Negative_Affect, by='CountryName')%>%
  full_join(Positive_Affect, by='CountryName')
```

# This contains the columns with only the required final ranks for each variable
```{r}
final_score <- final_score_table %>% select(CountryName,
                                            CountryCode, 
                                            finalscore_child,
                                            finalrank_comm,
                                            finalrank_diversity,
                                            finalrank_edu,
                                            finalrank_emission,
                                            finalrank_empl,
                                            finalrank_eng,
                                            finalrank_env,
                                            finalrank_deficit,
                                            finalrank_gen,
                                            finalrank_GDP,
                                            finalrank_pop,
                                            finalscore_security,
                                            finalrank_tourism,
                                            finalrank_hpi,
                                            finalrank_neg,
                                            finalrank_pos)
```


#drop countries with too many NA's and use of mean of the coutries other ranking to fill in NA'for remaining countries

```{r}
 final_score[rowSums(is.na(final_score)) < ncol(final_score)/2, ]
 final_score<- aggregate(x=final_score[c("finalscore_child",
                                            "finalrank_comm",
                                            "finalrank_diversity",
                                            "finalrank_edu",
                                            "finalrank_emission",
                                            "finalrank_empl",
                                            "finalrank_eng",
                                            "finalrank_env",
                                            "finalrank_deficit",
                                            "finalrank_gen",
                                            "finalrank_GDP",
                                            "finalrank_pop",
                                            "finalscore_security",
                                            "finalrank_tourism",
                                            "finalrank_hpi",
                                            "finalrank_neg",
                                            "finalrank_pos")], by=list(name=final_score$CountryName), FUN = "mean" , na.rm = TRUE)
 colnames(final_score)[1] <- "CountryName"
 
 final_score <- final_score[rowSums(is.na(final_score)) < 8, ]
 i <- which(is.na(final_score), arr.ind = TRUE)
 final_score[i] <- rowMeans(final_score[,2:18], na.rm = TRUE)[i[,1]]
 
final_score<- final_score %>% 
   mutate(ourindex = (finalscore_child + 
                        finalrank_comm + 
                        finalrank_diversity + 
                        finalrank_edu + 
                        finalrank_emission + 
                        finalrank_empl + 
                        finalrank_eng + 
                        finalrank_env + 
                        finalrank_deficit + 
                        finalrank_gen + 
                        finalrank_GDP + 
                        finalrank_pop + 
                        finalscore_security + 
                        finalrank_tourism + 
                        finalrank_hpi + 
                        finalrank_neg + 
                        finalrank_pos)/17) %>% 
  mutate(finalindex = rank(ourindex))

#fill in regional data
 
url <- "https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv"

regions <-read.csv(url)
regions <- regions %>% select(name, region, sub.region)
colnames(regions)[1] <- "CountryName"
final_score <- left_join(final_score, regions, "CountryName")
 


 write.csv(final_score, file = "CalculatedOurindex.csv")
```



# Fixing Regions
```{r}
read.csv("/IntroDSproject/Final score data/CalculatedOurindex.csv")
levels(CalculatedOurindex$CountryName)[levels(CalculatedOurindex$CountryName) == "Egypt, Arab Rep."] <- "Egypt"
levels(CalculatedOurindex$CountryName)[levels(CalculatedOurindex$CountryName) == "Lao PDR"] <- "Laos"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Bolivia" & is.na(CalculatedOurindex$sub.region)] <- "South America"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Egypt" & is.na(CalculatedOurindex$sub.region)] <- "Northern Africa"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Caribbean small states" & is.na(CalculatedOurindex$sub.region)] <- "South America"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Venezuela" & is.na(CalculatedOurindex$sub.region)] <- "South America"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Cote d'Ivoire" & is.na(CalculatedOurindex$sub.region)] <- "Western Africa"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Democratic Republic of Congo" & is.na(CalculatedOurindex$sub.region)] <- "Middle Africa"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Tanzania" & is.na(CalculatedOurindex$sub.region)] <- "Middle Africa"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Republic of Congo" & is.na(CalculatedOurindex$sub.region)] <- "Western Africa"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Iran" & is.na(CalculatedOurindex$sub.region)] <- "Western Asia"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Laos" & is.na(CalculatedOurindex$sub.region)] <- "South-Eastern Asia"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Macedonia" & is.na(CalculatedOurindex$sub.region)] <- "Southern Europe"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Moldova" & is.na(CalculatedOurindex$sub.region)] <- "Eastern Europe"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Russia" & is.na(CalculatedOurindex$sub.region)] <- "Eastern Europe"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "United Kingdom" & is.na(CalculatedOurindex$sub.region)] <- "Western Europe"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "South Korea" & is.na(CalculatedOurindex$sub.region)] <- "South-Eastern Asia"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Vietnam" & is.na(CalculatedOurindex$sub.region)] <- "South-Eastern Asia"

CalculatedOurindex$sub.region[CalculatedOurindex$CountryName == "Syria" & is.na(CalculatedOurindex$sub.region)] <- "Western Asia"

CalculatedOurindex$region[CalculatedOurindex$sub.region == "South America" & is.na(CalculatedOurindex$region)] <- "Americas"

CalculatedOurindex$region[(CalculatedOurindex$sub.region == "Western Africa" | CalculatedOurindex$sub.region == "Middle Africa" | CalculatedOurindex$sub.region == "Northern Africa")  & is.na(CalculatedOurindex$region)] <- "Africa"

CalculatedOurindex$region[(CalculatedOurindex$sub.region == "Western Asia" | CalculatedOurindex$sub.region == "South-Eastern Asia")  & is.na(CalculatedOurindex$region)] <- "Asia"

CalculatedOurindex$region[(CalculatedOurindex$sub.region == "Western Europe" | CalculatedOurindex$sub.region == "Eastern Europe" | CalculatedOurindex$sub.region == "Southern Europe")  & is.na(CalculatedOurindex$region)] <- "Europe"

#CalculatedOurindex <- CalculatedOurindex[rowSums(is.na(CalculatedOurindex)) > 0,]

write.csv(CalculatedOurindex, file = "CalculatedOurindex.csv")
## Final Analysis: What did you learn about the data? How did you answer the questions? How can you justify your answers?
